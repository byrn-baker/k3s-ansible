---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-conf
data:
  nginx.conf: |
    server {
        listen 80;
        listen 443 ssl;

        server_name plex.byrnbaker.me;

        rewrite     https://$host$request_uri?  permanent;

        error_log   /var/log/nginx/plex_error.log    error;
        access_log  /var/log/nginx/plex_access.log   combined;

        ssl_certificate /etc/letsencrypt/live/plex.byrnbaker.me/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/plex.byrnbaker.me/privkey.pem; # managed by Certbot

        resolver 1.1.1.1 1.0.0.1 valid=300s;
        resolver_timeout 10s;

        gzip on;
        gzip_vary on;
        gzip_min_length 1000;
        gzip_proxied any;
        gzip_types text/plain text/css text/xml application/xml text/javascript application/x-javascript image/svg+xml;
        gzip_disable "MSIE [1-6]\.";

        location / {
            proxy_pass          http://192.168.100.216:32400;
            proxy_buffering     off;
            proxy_redirect      off;
            proxy_http_version  1.1;
            proxy_set_header    X-Real-IP       $remote_addr;
            proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header    Upgrade         $http_upgrade;
            proxy_set_header    Connection      $http_connection;
            proxy_cookie_path   /web/           /;
            access_log          off;
        }
    }